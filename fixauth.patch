From ea90557b1122dff150839e3dfe5c01309191874f Mon Sep 17 00:00:00 2001
From: Codex <codex@openai.com>
Date: Sun, 1 Feb 2026 15:12:52 +0000
Subject: [PATCH] Fix auth context mismatch, unify ApiAuthContext, stabilize
 navbar and error handling

---
 src/App.tsx                            |  5 +-
 src/components/error/ErrorBoundary.tsx | 57 ++++++++++++++++
 src/components/layout/Navbar.tsx       | 36 +++++++---
 src/contexts/AuthContext.tsx           | 91 ++------------------------
 src/hooks/useUserRole.ts               | 49 ++------------
 src/pages/Auth.tsx                     |  4 +-
 src/pages/admin/ManageDocuments.tsx    |  4 +-
 src/pages/admin/ManageProperties.tsx   |  4 +-
 src/pages/client/Dashboard.tsx         |  3 -
 src/pages/client/Documents.tsx         |  4 +-
 src/pages/client/MyAssets.tsx          |  4 +-
 src/pages/client/ResaleRequest.tsx     |  4 +-
 12 files changed, 110 insertions(+), 155 deletions(-)
 create mode 100644 src/components/error/ErrorBoundary.tsx

diff --git a/src/App.tsx b/src/App.tsx
index e0b4303..087c694 100644
--- a/src/App.tsx
+++ b/src/App.tsx
@@ -12,6 +12,7 @@ import ProtectedRoute from "@/components/auth/ProtectedRoute";
 import LoadingScreen from "@/components/loading/LoadingScreen";
 import RouteLoadingHandler from "@/components/loading/RouteLoadingHandler";
 import CompareBar from "@/components/compare/CompareBar";
+import ErrorBoundary from "@/components/error/ErrorBoundary";
 import "@/lib/i18n";
 
 // Public Pages
@@ -273,7 +274,9 @@ const App = () => (
               <Toaster />
               <Sonner />
               <BrowserRouter>
-                <AppContent />
+                <ErrorBoundary>
+                  <AppContent />
+                </ErrorBoundary>
               </BrowserRouter>
             </TooltipProvider>
           </CompareProvider>
diff --git a/src/components/error/ErrorBoundary.tsx b/src/components/error/ErrorBoundary.tsx
new file mode 100644
index 0000000..876700c
--- /dev/null
+++ b/src/components/error/ErrorBoundary.tsx
@@ -0,0 +1,57 @@
+import React, { type ReactNode } from 'react';
+import { Button } from '@/components/ui/button';
+
+type ErrorBoundaryProps = {
+  children: ReactNode;
+  fallback?: ReactNode;
+};
+
+type ErrorBoundaryState = {
+  hasError: boolean;
+};
+
+class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
+  state: ErrorBoundaryState = {
+    hasError: false,
+  };
+
+  static getDerivedStateFromError() {
+    return { hasError: true };
+  }
+
+  componentDidCatch(error: Error, info: React.ErrorInfo) {
+    if (import.meta.env.DEV) {
+      console.error('ErrorBoundary caught an error:', error, info);
+    }
+  }
+
+  handleReload = () => {
+    window.location.reload();
+  };
+
+  render() {
+    if (this.state.hasError) {
+      return (
+        this.props.fallback ?? (
+          <div className="min-h-screen flex items-center justify-center bg-background px-6">
+            <div className="glass-card max-w-md w-full p-8 text-center border border-border/30">
+              <h1 className="font-display text-2xl text-foreground mb-3">
+                Something went wrong
+              </h1>
+              <p className="text-muted-foreground mb-6">
+                Please refresh the page or try again later.
+              </p>
+              <Button className="btn-gold" onClick={this.handleReload}>
+                Reload
+              </Button>
+            </div>
+          </div>
+        )
+      );
+    }
+
+    return this.props.children;
+  }
+}
+
+export default ErrorBoundary;
diff --git a/src/components/layout/Navbar.tsx b/src/components/layout/Navbar.tsx
index a760c15..316eab4 100644
--- a/src/components/layout/Navbar.tsx
+++ b/src/components/layout/Navbar.tsx
@@ -2,10 +2,9 @@ import { useState } from 'react';
 import { Link, useLocation, useNavigate } from 'react-router-dom';
 import { useTranslation } from 'react-i18next';
 import { motion, AnimatePresence } from 'framer-motion';
-import { Menu, X, Globe, User, LogOut, ChevronDown } from 'lucide-react';
+import { Menu, X, Globe, User, LogOut, ChevronDown, Loader2 } from 'lucide-react';
 import { useLanguage } from '@/contexts/LanguageContext';
-import { useAuth } from '@/contexts/AuthContext';
-import { useUserRole } from '@/hooks/useUserRole';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { Button } from '@/components/ui/button';
 import {
   DropdownMenu,
@@ -19,8 +18,7 @@ import sourceLogo from '@/assets/source-logo.svg';
 const Navbar = () => {
   const { t } = useTranslation();
   const { language, setLanguage, isRTL } = useLanguage();
-  const { user, signOut } = useAuth();
-  const { isAdmin } = useUserRole();
+  const { user, signOut, isLoading } = useApiAuth();
   const location = useLocation();
   const navigate = useNavigate();
   const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
@@ -41,7 +39,13 @@ const Navbar = () => {
     navigate('/auth', { replace: true });
   };
 
-  const portalPath = isAdmin ? '/admin/dashboard' : '/client-portal/dashboard';
+  const userRole = user?.role;
+  const portalPath =
+    userRole === 'admin' || userRole === 'super_admin'
+      ? '/admin/dashboard'
+      : userRole === 'agent'
+        ? '/agent/dashboard'
+        : '/client-portal/dashboard';
 
   return (
     <nav className="fixed top-0 left-0 right-0 z-50">
@@ -96,7 +100,12 @@ const Navbar = () => {
               </DropdownMenu>
 
               {/* Auth Buttons */}
-              {user ? (
+              {isLoading ? (
+                <Button variant="ghost" className="gap-2 text-muted-foreground" disabled>
+                  <Loader2 className="w-4 h-4 animate-spin" />
+                  {t('common.loading')}
+                </Button>
+              ) : user ? (
                 <DropdownMenu>
                   <DropdownMenuTrigger asChild>
                     <Button variant="ghost" className="gap-2 text-muted-foreground hover:text-foreground">
@@ -107,7 +116,7 @@ const Navbar = () => {
                   <DropdownMenuContent align={isRTL ? 'start' : 'end'} className="glass-card border-border/50">
                     <DropdownMenuItem asChild>
                       <Link to={portalPath}>
-                        {isAdmin ? 'Admin Dashboard' : 'My Portal'}
+                        {user?.role === 'admin' || user?.role === 'super_admin' ? 'Admin Dashboard' : 'My Portal'}
                       </Link>
                     </DropdownMenuItem>
                     <DropdownMenuItem onClick={handleSignOut} className="text-destructive">
@@ -164,11 +173,18 @@ const Navbar = () => {
                   {link.label}
                 </Link>
               ))}
-              {user ? (
+              {isLoading ? (
+                <div className="pt-4 border-t border-border/50">
+                  <Button variant="ghost" className="w-full text-muted-foreground" disabled>
+                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
+                    {t('common.loading')}
+                  </Button>
+                </div>
+              ) : user ? (
                 <div className="pt-4 border-t border-border/50 space-y-3">
                   <Link to={portalPath} onClick={() => setIsMobileMenuOpen(false)}>
                     <Button variant="outline" className="w-full border-border/50">
-                      {isAdmin ? 'Admin Dashboard' : 'My Portal'}
+                      {user?.role === 'admin' || user?.role === 'super_admin' ? 'Admin Dashboard' : 'My Portal'}
                     </Button>
                   </Link>
                   <Button 
diff --git a/src/contexts/AuthContext.tsx b/src/contexts/AuthContext.tsx
index 31f4a87..bbda81a 100644
--- a/src/contexts/AuthContext.tsx
+++ b/src/contexts/AuthContext.tsx
@@ -1,87 +1,6 @@
-import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';
-import { User, Session } from '@supabase/supabase-js';
-import { supabase } from '@/integrations/supabase/client';
+/**
+ * @deprecated Legacy Supabase AuthContext has been removed.
+ * Use ApiAuthContext instead.
+ */
 
-interface AuthContextType {
-  user: User | null;
-  session: Session | null;
-  isLoading: boolean;
-  signIn: (email: string, password: string) => Promise<{ error: Error | null }>;
-  signUp: (email: string, password: string) => Promise<{ error: Error | null }>;
-  signOut: () => Promise<void>;
-}
-
-const AuthContext = createContext<AuthContextType | undefined>(undefined);
-
-export const AuthProvider = ({ children }: { children: ReactNode }) => {
-  const [user, setUser] = useState<User | null>(null);
-  const [session, setSession] = useState<Session | null>(null);
-  const [isLoading, setIsLoading] = useState(true);
-
-  useEffect(() => {
-    // Set up auth state listener FIRST
-    const { data: { subscription } } = supabase.auth.onAuthStateChange(
-      (event, session) => {
-        setSession(session);
-        setUser(session?.user ?? null);
-        setIsLoading(false);
-      }
-    );
-
-    // THEN check for existing session
-    supabase.auth.getSession().then(({ data: { session } }) => {
-      setSession(session);
-      setUser(session?.user ?? null);
-      setIsLoading(false);
-    });
-
-    return () => subscription.unsubscribe();
-  }, []);
-
-  const signIn = async (email: string, password: string) => {
-    const { error } = await supabase.auth.signInWithPassword({
-      email,
-      password,
-    });
-    return { error };
-  };
-
-  const signUp = async (email: string, password: string) => {
-    const redirectUrl = `${window.location.origin}/`;
-    const { error } = await supabase.auth.signUp({
-      email,
-      password,
-      options: {
-        emailRedirectTo: redirectUrl,
-      },
-    });
-    return { error };
-  };
-
-  const signOut = async () => {
-    await supabase.auth.signOut();
-  };
-
-  return (
-    <AuthContext.Provider
-      value={{
-        user,
-        session,
-        isLoading,
-        signIn,
-        signUp,
-        signOut,
-      }}
-    >
-      {children}
-    </AuthContext.Provider>
-  );
-};
-
-export const useAuth = () => {
-  const context = useContext(AuthContext);
-  if (!context) {
-    throw new Error('useAuth must be used within an AuthProvider');
-  }
-  return context;
-};
+export {};
diff --git a/src/hooks/useUserRole.ts b/src/hooks/useUserRole.ts
index 9548028..7c4b8cc 100644
--- a/src/hooks/useUserRole.ts
+++ b/src/hooks/useUserRole.ts
@@ -1,52 +1,15 @@
-import { useState, useEffect } from 'react';
-import { useAuth } from '@/contexts/AuthContext';
-import { supabase } from '@/integrations/supabase/client';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 
-type AppRole = 'admin' | 'client' | null;
+type AppRole = 'admin' | 'client' | 'agent' | 'sales_agent' | 'super_admin' | null;
 
 export const useUserRole = () => {
-  const { user, isLoading: authLoading } = useAuth();
-  const [role, setRole] = useState<AppRole>(null);
-  const [isLoading, setIsLoading] = useState(true);
-
-  useEffect(() => {
-    const fetchRole = async () => {
-      if (!user) {
-        setRole(null);
-        setIsLoading(false);
-        return;
-      }
-
-      try {
-        const { data, error } = await supabase
-          .from('user_roles')
-          .select('role')
-          .eq('user_id', user.id)
-          .maybeSingle();
-
-        if (error) {
-          console.error('Error fetching user role:', error);
-          setRole(null);
-        } else {
-          setRole(data?.role as AppRole || 'client');
-        }
-      } catch (err) {
-        console.error('Error in useUserRole:', err);
-        setRole(null);
-      } finally {
-        setIsLoading(false);
-      }
-    };
-
-    if (!authLoading) {
-      fetchRole();
-    }
-  }, [user, authLoading]);
+  const { user, isLoading: authLoading } = useApiAuth();
+  const role = (user?.role as AppRole) ?? null;
 
   return {
     role,
-    isAdmin: role === 'admin',
+    isAdmin: role === 'admin' || role === 'super_admin',
     isClient: role === 'client',
-    isLoading: authLoading || isLoading,
+    isLoading: authLoading,
   };
 };
diff --git a/src/pages/Auth.tsx b/src/pages/Auth.tsx
index af74644..15a72e0 100644
--- a/src/pages/Auth.tsx
+++ b/src/pages/Auth.tsx
@@ -1,7 +1,7 @@
 import { useState, useEffect } from 'react';
 import { useNavigate } from 'react-router-dom';
 import { motion } from 'framer-motion';
-import { useAuth } from '@/contexts/AuthContext';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { Button } from '@/components/ui/button';
 import { Input } from '@/components/ui/input';
 import { Label } from '@/components/ui/label';
@@ -23,7 +23,7 @@ const Auth = () => {
   const [rememberMe, setRememberMe] = useState(false);
   const [isLoading, setIsLoading] = useState(false);
   const [errors, setErrors] = useState<{ email?: string; password?: string }>({});
-  const { signIn, user, isLoading: authLoading } = useAuth();
+  const { signIn, user, isLoading: authLoading } = useApiAuth();
   const navigate = useNavigate();
 
   // Redirect if already logged in
diff --git a/src/pages/admin/ManageDocuments.tsx b/src/pages/admin/ManageDocuments.tsx
index 5ce97c5..0328de0 100644
--- a/src/pages/admin/ManageDocuments.tsx
+++ b/src/pages/admin/ManageDocuments.tsx
@@ -29,7 +29,7 @@ import {
   SelectValue,
 } from '@/components/ui/select';
 import { supabase } from '@/integrations/supabase/client';
-import { useAuth } from '@/contexts/AuthContext';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { toast } from 'sonner';
 
 interface Document {
@@ -47,7 +47,7 @@ interface PropertyOption {
 }
 
 const ManageDocuments = () => {
-  const { user } = useAuth();
+  const { user } = useApiAuth();
   const [documents, setDocuments] = useState<Document[]>([]);
   const [properties, setProperties] = useState<PropertyOption[]>([]);
   const [searchQuery, setSearchQuery] = useState('');
diff --git a/src/pages/admin/ManageProperties.tsx b/src/pages/admin/ManageProperties.tsx
index 9f73db3..44c17e1 100644
--- a/src/pages/admin/ManageProperties.tsx
+++ b/src/pages/admin/ManageProperties.tsx
@@ -34,7 +34,7 @@ import {
 } from '@/components/ui/select';
 import { Slider } from '@/components/ui/slider';
 import { supabase } from '@/integrations/supabase/client';
-import { useAuth } from '@/contexts/AuthContext';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { toast } from 'sonner';
 
 interface Property {
@@ -61,7 +61,7 @@ interface UserOption {
 }
 
 const ManageProperties = () => {
-  const { user } = useAuth();
+  const { user } = useApiAuth();
   const [properties, setProperties] = useState<Property[]>([]);
   const [users, setUsers] = useState<UserOption[]>([]);
   const [searchQuery, setSearchQuery] = useState('');
diff --git a/src/pages/client/Dashboard.tsx b/src/pages/client/Dashboard.tsx
index 5863519..d6d230d 100644
--- a/src/pages/client/Dashboard.tsx
+++ b/src/pages/client/Dashboard.tsx
@@ -2,7 +2,6 @@ import { Link } from 'react-router-dom';
 import { motion } from 'framer-motion';
 import { Building2, FileText, RefreshCw, ArrowRight } from 'lucide-react';
 import PortalLayout from '@/components/portal/PortalLayout';
-import { useAuth } from '@/contexts/AuthContext';
 
 const dashboardTiles = [
   {
@@ -32,8 +31,6 @@ const dashboardTiles = [
 ];
 
 const ClientDashboard = () => {
-  const { user } = useAuth();
-
   return (
     <PortalLayout
       title="Welcome Back"
diff --git a/src/pages/client/Documents.tsx b/src/pages/client/Documents.tsx
index 98b35dc..f32aa7c 100644
--- a/src/pages/client/Documents.tsx
+++ b/src/pages/client/Documents.tsx
@@ -3,7 +3,7 @@ import { motion } from 'framer-motion';
 import { FileText, Download, Building2, Loader2, AlertCircle, CheckCircle } from 'lucide-react';
 import PortalLayout from '@/components/portal/PortalLayout';
 import { Button } from '@/components/ui/button';
-import { useAuth } from '@/contexts/AuthContext';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { supabase } from '@/integrations/supabase/client';
 import { toast } from 'sonner';
 
@@ -20,7 +20,7 @@ interface Document {
 }
 
 const Documents = () => {
-  const { user } = useAuth();
+  const { user } = useApiAuth();
   const [documents, setDocuments] = useState<Document[]>([]);
   const [isLoading, setIsLoading] = useState(true);
   const [downloadingId, setDownloadingId] = useState<string | null>(null);
diff --git a/src/pages/client/MyAssets.tsx b/src/pages/client/MyAssets.tsx
index e4ed9d6..7a13ecd 100644
--- a/src/pages/client/MyAssets.tsx
+++ b/src/pages/client/MyAssets.tsx
@@ -4,7 +4,7 @@ import { Building2, MapPin, Loader2, AlertCircle } from 'lucide-react';
 import PortalLayout from '@/components/portal/PortalLayout';
 import { Progress } from '@/components/ui/progress';
 import { Badge } from '@/components/ui/badge';
-import { useAuth } from '@/contexts/AuthContext';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { supabase } from '@/integrations/supabase/client';
 
 interface Property {
@@ -21,7 +21,7 @@ interface Property {
 }
 
 const MyAssets = () => {
-  const { user } = useAuth();
+  const { user } = useApiAuth();
   const [properties, setProperties] = useState<Property[]>([]);
   const [isLoading, setIsLoading] = useState(true);
   const [error, setError] = useState<string | null>(null);
diff --git a/src/pages/client/ResaleRequest.tsx b/src/pages/client/ResaleRequest.tsx
index 37e637c..1310510 100644
--- a/src/pages/client/ResaleRequest.tsx
+++ b/src/pages/client/ResaleRequest.tsx
@@ -20,7 +20,7 @@ import {
   SelectTrigger,
   SelectValue,
 } from '@/components/ui/select';
-import { useAuth } from '@/contexts/AuthContext';
+import { useApiAuth } from '@/contexts/ApiAuthContext';
 import { supabase } from '@/integrations/supabase/client';
 import { toast } from 'sonner';
 
@@ -39,7 +39,7 @@ interface ResaleRequest {
 }
 
 const ResaleRequest = () => {
-  const { user } = useAuth();
+  const { user } = useApiAuth();
   const [properties, setProperties] = useState<Property[]>([]);
   const [requests, setRequests] = useState<ResaleRequest[]>([]);
   const [selectedProperty, setSelectedProperty] = useState<string>('');
-- 
2.43.0
